<html>
  <head>
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="https://apis.google.com/js/api.js" type="text/javascript"></script>
   <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCY5Ko2G-pybtFUctOe-FH0uWc7u-NcYr0&libraries=places"
    ></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
    <title>Buddycenter</title>
  </head>
  <body>
    <h1 style="text-align: center;">Buddycenter</h1>
    <form style="text-align: center;" id="address-form">
    </form>
    <div class="container" style="text-align: center;">
    <button class="btn btn-primary" type="button" onclick="addAddressField()">Add an address</button>
    <br>
    <br>
    <button id='toto' class="btn btn-primary" type="button" onclick="calculateMidpoint()">Go!</button>
    </form> 
    <br>
  </div>
    <div style="text-align: center;" id="output"></div>
    <div style="text-align: center;" id="places"></div>

    <div style="margin-left: auto; margin-right: auto; text-align: center;height: 50%; width:70%;" id="map">
    </div>

    <script type="text/javascript">
      var addressCounter = 0;
      function displayMap(lat, lng) {
      map = new google.maps.Map(document.getElementById("map"), {
        center: new google.maps.LatLng(lat, lng),
        zoom: 10,
      })
    marker  = new google.maps.Marker({
    position: { lat: lat, lng: lng},
    map,
    animation: google.maps.Animation.DROP,
    label: "buddycenter",
  })

  marker.addListener("click", toggleBounce);

function toggleBounce() {
  if (marker.getAnimation() !== null) {
    marker.setAnimation(null);
  } else {
    marker.setAnimation(google.maps.Animation.BOUNCE);
  }
}
    }


  function addAddressField() {
    // Incrémenter le compteur d'adresses
    addressCounter++;

    // Créer un nouveau champ de saisie pour l'adresse
    var newAddressField = document.createElement("input");
    newAddressField.setAttribute("class", "input-group-text");
    newAddressField.setAttribute("type", "text");
    newAddressField.setAttribute("id", "address" + addressCounter);
    newAddressField.setAttribute("name", "address" + addressCounter);
    newAddressField.setAttribute("style", "margin: auto;");
    newAddressField.style.width = "40%";

    var removeButton = document.createElement("button");
    removeButton.setAttribute("id", "remove" + addressCounter);
    removeButton.setAttribute("class", "btn btn-primary");
    //removeButton.style.width = "100px";
    //removeButton.style.height = "30px";
    removeButton.textContent = "remove";
    removeButton.setAttribute("value", "remove");
    removeButton.setAttribute("type", "button");



    // Ajouter le champ de saisie et son étiquette à la page
    var addressForm = document.getElementById("address-form");
    addressForm.appendChild(newAddressField);
    addressForm.appendChild(removeButton);

    addressForm.appendChild(document.createElement("br"));

    removeButton.addEventListener('click', () => {
      newAddressField.remove();
      removeButton.remove();
      
});

  // Create the autocomplete object, restricting the search predictions to
  autocomplete = new google.maps.places.Autocomplete(newAddressField, {
    fields: ["address_components", "geometry"],
    types: ["address"],
  })
}

      // Remplacez YOUR_API_KEY par votre clé d'API Google Maps Geocoding
      var apiKey = 'AIzaSyCY5Ko2G-pybtFUctOe-FH0uWc7u-NcYr0';
      var lat;
      var lng;
      addAddressField();
      addAddressField();
      async function fetchUrl(url) {
        try {
            const response = await fetch(url, {
                method: 'GET',
                mode: "cors"
            });
            const exam = await response.json();
            if (response.status == 200) {
              return exam;
            }
            else {
              alert("Bad request");
              return;
            }
        } catch (error) {
            console.error(error);
        }
    }

    async function calculatePoint(address) {
      if (address === "") {
        alert("empty addres")
        return;
      }
      var url = 'https://maps.googleapis.com/maps/api/geocode/json?address=' + encodeURIComponent(address) + '&key=' + apiKey;
      // Envoyer une requête HTTP GET à l'API pour chaque adresse
      var response = await fetchUrl(url);
      
      console.log("response: " + JSON.stringify(response))

      if (response.results.length > 0) {
      lat = response.results[0].geometry.location.lat;
      lng = response.results[0].geometry.location.lng;
      console.log("lat func: " + lat)

      return [lat, lng];
      }
      else {
        alert("No valid answer")
        return;
      }
    }
    async function calculateMidpoint() {
    // Récupérer tous les champs de saisie d'adresse
    var addressFields = document.querySelectorAll("input[name^='address']");
    // Créer un tableau pour stocker les adresses
    var addresses = [];

    // Ajouter les adresses saisies dans le tableau
    addressFields.forEach(function(addressField) {
      if (addressField.value) {
        addresses.push(addressField.value);
      }
    });
    // Vérifie si il y a des adresses
    if (addresses.length < 2) {
      alert("Veuillez saisir au moins 2 adresses.");
      return;
    }
    var lat_total = 0.0;
    var lng_total = 0.0;
    for (let i = 0; i <addressFields.length; i++) {
      var coord = await calculatePoint(addressFields[i].value);
      console.log("coord[0] " + coord[0])

      lat_total = parseFloat(coord[0]) + lat_total;
      lng_total = parseFloat(coord[1]) + lng_total;
      console.log("lat: " + lat_total)
      console.log("lng: " + lng_total)
  

  }
    lat = lat_total / addressFields.length;
    lng = lng_total / addressFields.length;

    // Afficher les coordonnées GPS moyennes à l'utilisateur
    var url3 = 'https://maps.googleapis.com/maps/api/geocode/json?latlng=' + lat + ',' + lng +'&key=' + apiKey;
    var response = await fetchUrl(url3);
    address = response.results[0].formatted_address
    document.getElementById('output').innerHTML = "<br><br><span class=\"label label-primary\">Adress: " + address + "</span><br><br>";

    displayMap(lat, lng);
    calculatePoint(address);
    }

      </script>
      </body>
</html>
